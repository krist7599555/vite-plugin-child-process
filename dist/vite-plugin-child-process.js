import debug from "debug";
import path from "node:path";
import { debounce, filter, interval, map, Observable, startWith, tap, } from "rxjs";
import { $ } from "zx";
export const child_process = (config) => {
    const _command = config.command;
    const _delay = config?.delay ?? 10;
    const _watch = config?.watch.map((w) => typeof w == "string" ? new RegExp(w) : w);
    const _throw = config?.throw ?? true;
    const log = debug(`vite:child-process:${config.name ?? "untitle"}`);
    log.enabled = config?.log_enable ?? true;
    const log_watcher = log.extend("watcher");
    const old_process = [];
    async function kill_all_process() {
        for (const ps of old_process) {
            await ps.kill();
            await ps.exitCode;
        }
    }
    return {
        name: "vite-plugin-vite-child-process",
        enforce: "post",
        apply: "serve",
        async closeBundle() {
            log_watcher("close bundle");
            await kill_all_process();
        },
        async configureServer({ watcher }) {
            log_watcher("start configure server");
            log_watcher("watcher file change", JSON.stringify(_watch.map((r) => `${r}`)));
            const files = new Observable((o) => {
                watcher.on("ready", () => o.next(""));
                watcher.on("change", (id) => o.next(id));
                watcher.on("add", (id) => o.next(id));
            });
            const filechange$ = files.pipe(filter((id) => _watch.some((regex) => regex.test(id))), map((fullpath) => path.relative(path.resolve(), fullpath)), // change to realtive
            debounce(() => interval(_delay)), tap((id) => log_watcher("filechange " + id)), startWith(null));
            filechange$.subscribe(async () => {
                await kill_all_process();
                const local_process = $ `${_command}`;
                old_process.push(local_process);
                local_process.quiet();
                if (!_throw) {
                    local_process.nothrow();
                }
                local_process.stderr.on("data", (s) => log(s.toString().trimEnd()));
                local_process.stderr.on("error", (s) => log(s.toString().trimEnd()));
                local_process.stdout.on("data", (s) => log(s.toString().trimEnd()));
                local_process.stdout.on("error", (s) => log(s.toString().trimEnd()));
            });
        },
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidml0ZS1wbHVnaW4tY2hpbGQtcHJvY2Vzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi92aXRlLXBsdWdpbi1jaGlsZC1wcm9jZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLElBQUksTUFBTSxXQUFXLENBQUM7QUFFN0IsT0FBTyxFQUNMLFFBQVEsRUFDUixNQUFNLEVBQ04sUUFBUSxFQUNSLEdBQUcsRUFDSCxVQUFVLEVBQ1YsU0FBUyxFQUNULEdBQUcsR0FDSixNQUFNLE1BQU0sQ0FBQztBQUVkLE9BQU8sRUFBdUIsQ0FBQyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBa0I1QyxNQUFNLENBQUMsTUFBTSxhQUFhLEdBQUcsQ0FBQyxNQUE4QixFQUFVLEVBQUU7SUFDdEUsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztJQUNoQyxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNuQyxNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQ3JDLE9BQU8sQ0FBQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDekMsQ0FBQztJQUNGLE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxLQUFLLElBQUksSUFBSSxDQUFDO0lBRXJDLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxzQkFBc0IsTUFBTSxDQUFDLElBQUksSUFBSSxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ3BFLEdBQUcsQ0FBQyxPQUFPLEdBQUcsTUFBTSxFQUFFLFVBQVUsSUFBSSxJQUFJLENBQUM7SUFFekMsTUFBTSxXQUFXLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUUx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RUFBRSxFQUFFLENBQzdDLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FDNUIsQ0FBQztnQkFDRixhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFTLEVBQUUsRUFBRSxDQUM1QyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQzVCLENBQUM7Z0JBQ0YsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBUyxFQUFFLEVBQUUsQ0FDN0MsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUM1QixDQUFDO1lBQ0osQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1ZyBmcm9tIFwiZGVidWdcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJub2RlOnBhdGhcIjtcbmltcG9ydCB7IFN0cmVhbSB9IGZyb20gXCJub2RlOnN0cmVhbVwiO1xuaW1wb3J0IHtcbiAgZGVib3VuY2UsXG4gIGZpbHRlcixcbiAgaW50ZXJ2YWwsXG4gIG1hcCxcbiAgT2JzZXJ2YWJsZSxcbiAgc3RhcnRXaXRoLFxuICB0YXAsXG59IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyB0eXBlIFBsdWdpbiB9IGZyb20gXCJ2aXRlXCI7XG5pbXBvcnQgeyB0eXBlIFByb2Nlc3NQcm9taXNlLCAkIH0gZnJvbSBcInp4XCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVml0ZVBsdWdpbkNoaWxkUHJvY2VzcyB7XG4gIC8qKiBjb21tYW5kIG5hbWUgZm9yIHByZWZpeCBsb2cgb3VwdXQgQGRlZmF1bHQgXCJ1bnRpdGxlXCIgKi9cbiAgbmFtZT86IHN0cmluZztcbiAgLyoqIGNvbW1hbmQgdG8gcnVuICovXG4gIGNvbW1hbmQ6IHN0cmluZ1tdO1xuICAvKiogQGRlZmF1bHQgMTBtcyAqL1xuICBkZWxheT86IG51bWJlcjtcbiAgLyoqIHZpdGUgd2F0Y2ggZmlsZSBjaGFuZ2UgKi9cbiAgd2F0Y2g6IChSZWdFeHAgfCBzdHJpbmcpW107XG4gIC8qKiBAZGVmYXVsdCB0cnVlICovXG4gIGxvZ19lbmFibGU/OiBib29sZWFuO1xuXG4gIC8qKiBAZGVmYXVsdCB0cnVlICovXG4gIHRocm93PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNvbnN0IGNoaWxkX3Byb2Nlc3MgPSAoY29uZmlnOiBWaXRlUGx1Z2luQ2hpbGRQcm9jZXNzKTogUGx1Z2luID0+IHtcbiAgY29uc3QgX2NvbW1hbmQgPSBjb25maWcuY29tbWFuZDtcbiAgY29uc3QgX2RlbGF5ID0gY29uZmlnPy5kZWxheSA/PyAxMDtcbiAgY29uc3QgX3dhdGNoID0gY29uZmlnPy53YXRjaC5tYXAoKHcpID0+XG4gICAgdHlwZW9mIHcgPT0gXCJzdHJpbmdcIiA/IG5ldyBSZWdFeHAodykgOiB3XG4gICk7XG4gIGNvbnN0IF90aHJvdyA9IGNvbmZpZz8udGhyb3cgPz8gdHJ1ZTtcblxuICBjb25zdCBsb2cgPSBkZWJ1Zyhgdml0ZTpjaGlsZC1wcm9jZXNzOiR7Y29uZmlnLm5hbWUgPz8gXCJ1bnRpdGxlXCJ9YCk7XG4gIGxvZy5lbmFibGVkID0gY29uZmlnPy5sb2dfZW5hYmxlID8/IHRydWU7XG5cbiAgY29uc3QgbG9nX3dhdGNoZXIgPSBsb2cuZXh0ZW5kKFwid2F0Y2hlclwiKTtcblxuICBjb25zdCBvbGRfcHJvY2VzczogUHJvY2Vzc1Byb21pc2VbXSA9IFtdO1xuICBhc3luYyBmdW5jdGlvbiBraWxsX2FsbF9wcm9jZXNzKCkge1xuICAgIGZvciAoY29uc3QgcHMgb2Ygb2xkX3Byb2Nlc3MpIHtcbiAgICAgIGF3YWl0IHBzLmtpbGwoKTtcbiAgICAgIGF3YWl0IHBzLmV4aXRDb2RlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbmFtZTogXCJ2aXRlLXBsdWdpbi12aXRlLWNoaWxkLXByb2Nlc3NcIixcbiAgICBlbmZvcmNlOiBcInBvc3RcIixcbiAgICBhcHBseTogXCJzZXJ2ZVwiLFxuICAgIGFzeW5jIGNsb3NlQnVuZGxlKCkge1xuICAgICAgbG9nX3dhdGNoZXIoXCJjbG9zZSBidW5kbGVcIik7XG4gICAgICBhd2FpdCBraWxsX2FsbF9wcm9jZXNzKCk7XG4gICAgfSxcbiAgICBhc3luYyBjb25maWd1cmVTZXJ2ZXIoeyB3YXRjaGVyIH0pIHtcbiAgICAgIGxvZ193YXRjaGVyKFwic3RhcnQgY29uZmlndXJlIHNlcnZlclwiKTtcbiAgICAgIGxvZ193YXRjaGVyKFxuICAgICAgICBcIndhdGNoZXIgZmlsZSBjaGFuZ2VcIixcbiAgICAgICAgSlNPTi5zdHJpbmdpZnkoX3dhdGNoLm1hcCgocikgPT4gYCR7cn1gKSlcbiAgICAgICk7XG4gICAgICBjb25zdCBmaWxlcyA9IG5ldyBPYnNlcnZhYmxlPHN0cmluZz4oKG8pID0+IHtcbiAgICAgICAgd2F0Y2hlci5vbihcInJlYWR5XCIsICgpID0+IG8ubmV4dChcIlwiKSk7XG4gICAgICAgIHdhdGNoZXIub24oXCJjaGFuZ2VcIiwgKGlkKSA9PiBvLm5leHQoaWQpKTtcbiAgICAgICAgd2F0Y2hlci5vbihcImFkZFwiLCAoaWQpID0+IG8ubmV4dChpZCkpO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGZpbGVjaGFuZ2UkID0gZmlsZXMucGlwZShcbiAgICAgICAgZmlsdGVyKChpZCkgPT4gX3dhdGNoLnNvbWUoKHJlZ2V4KSA9PiByZWdleC50ZXN0KGlkKSkpLFxuICAgICAgICBtYXAoKGZ1bGxwYXRoKSA9PiBwYXRoLnJlbGF0aXZlKHBhdGgucmVzb2x2ZSgpLCBmdWxscGF0aCkpLCAvLyBjaGFuZ2UgdG8gcmVhbHRpdmVcbiAgICAgICAgZGVib3VuY2UoKCkgPT4gaW50ZXJ2YWwoX2RlbGF5KSksXG4gICAgICAgIHRhcCgoaWQpID0+IGxvZ193YXRjaGVyKFwiZmlsZWNoYW5nZSBcIiArIGlkKSksXG4gICAgICAgIHN0YXJ0V2l0aChudWxsKVxuICAgICAgKTtcblxuICAgICAgZmlsZWNoYW5nZSQuc3Vic2NyaWJlKGFzeW5jICgpID0+IHtcbiAgICAgICAgYXdhaXQga2lsbF9hbGxfcHJvY2VzcygpO1xuICAgICAgICBjb25zdCBsb2NhbF9wcm9jZXNzOiBQcm9jZXNzUHJvbWlzZSA9ICRgJHtfY29tbWFuZH1gO1xuICAgICAgICBvbGRfcHJvY2Vzcy5wdXNoKGxvY2FsX3Byb2Nlc3MpO1xuXG4gICAgICAgIGxvY2FsX3Byb2Nlc3MucXVpZXQoKTtcbiAgICAgICAgaWYgKCFfdGhyb3cpIHtcbiAgICAgICAgICBsb2NhbF9wcm9jZXNzLm5vdGhyb3coKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxvY2FsX3Byb2Nlc3Muc3RkZXJyLm9uKFwiZGF0YVwiLCAoczogU3RyZWFtKSA9PlxuICAgICAgICAgIGxvZyhzLnRvU3RyaW5nKCkudHJpbUVuZCgpKVxuICAgICAgICApO1xuICAgICAgICBsb2NhbF9wcm9jZXNzLnN0ZGVyci5vbihcImVycm9yXCIsIChzOiBTdHJlYW0pID0+XG4gICAgICAgICAgbG9nKHMudG9TdHJpbmcoKS50cmltRW5kKCkpXG4gICAgICAgICk7XG4gICAgICAgIGxvY2FsX3Byb2Nlc3Muc3Rkb3V0Lm9uKFwiZGF0YVwiLCAoczogU3RyZWFtKSA9PlxuICAgICAgICAgIGxvZyhzLnRvU3RyaW5nKCkudHJpbUVuZCgpKVxuICAgICAgICApO1xuICAgICAgICBsb2NhbF9wcm9jZXNzLnN0ZG91dC5vbihcImVycm9yXCIsIChzOiBTdHJlYW0pID0+XG4gICAgICAgICAgbG9nKHMudG9TdHJpbmcoKS50cmltRW5kKCkpXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9LFxuICB9O1xufTtcbiJdfQ==